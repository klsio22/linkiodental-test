### Lab Orders API - Test Collection with Authentication
### Base URL
@baseUrl = http://localhost:3000
@apiUrl = {{baseUrl}}/api

###############################################################################
### USERS - REGISTRATION (Staff vs Clients)
###############################################################################

### 1. Register ATTENDANT (Staff - Can Create Orders)
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "attendant@lab.com",
  "password": "senha123",
  "name": "Maria Atendente",
  "role": "ATTENDANT"
}

### 2. Register CUSTOMER (Client/Patient - Cannot Create Orders)
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "customer@example.com",
  "password": "senha123",
  "name": "João Silva (Paciente)",
  "role": "CUSTOMER"
}

### 3. Register LAB_ADMIN
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "admin@lab.com",
  "password": "admin123",
  "name": "Admin Lab",
  "role": "LAB_ADMIN"
}

###############################################################################
### USERS - LOGIN
###############################################################################

### 4. Login as ATTENDANT
POST {{apiUrl}}/users/login HTTP/1.1
Content-Type: application/json

{
  "email": "attendant@lab.com",
  "password": "senha123"
}

### 5. Login as CUSTOMER
POST {{apiUrl}}/users/login HTTP/1.1
Content-Type: application/json

{
  "email": "customer@example.com",
  "password": "senha123"
}

### 6. Login as LAB_ADMIN
POST {{apiUrl}}/users/login HTTP/1.1
Content-Type: application/json

{
  "email": "admin@lab.com",
  "password": "admin123"
}

###############################################################################
### USERS - PROFILE
###############################################################################

### 7. Get User Profile
GET {{apiUrl}}/users/profile HTTP/1.1
Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5NWM0NTI3ODdhOTBmYjZjZDRhMjEzYyIsInJvbGUiOiJBVFRFTkRBTlQiLCJpYXQiOjE3Njc2NTQ4MzEsImV4cCI6MTc2ODI1OTYzMX0.xKd5qbOdRi0w9_lnlErIzfdKwiQGXH5FYpsEd-Afh_Y

### 8. Update User Profile
PUT {{apiUrl}}/users/profile HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "name": "João Silva Updated"
}

###############################################################################
### ORDERS - CREATE (Only ATTENDANT/LAB_ADMIN/SUPER_ADMIN)
###############################################################################

### 9. Create Order - ATTENDANT Success
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {attendant_token}
Content-Type: application/json

{
  "lab": "Lab Sorriso",
  "patient": "João Silva",
  "customer": "Dr. Maria Santos",
  "services": [
    {
      "name": "Coroa de Porcelana",
      "value": 800.00,
      "status": "PENDING"
    },
    {
      "name": "Implante Dentário",
      "value": 1700.00,
      "status": "PENDING"
    }
  ]
}

### 10. Create Order - CUSTOMER Error (403 Forbidden)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {customer_token}
Content-Type: application/json

{
  "lab": "Lab Sorriso",
  "patient": "Ana Silva",
  "customer": "Dr. Pedro Lima",
  "services": [
    {
      "name": "Limpeza",
      "value": 300.00
    }
  ]
}

### 11. Create Order - Multiple Services
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {attendant_token}
Content-Type: application/json

{
  "lab": "Lab Perfecto",
  "patient": "Ana Costa",
  "customer": "Dr. Pedro Lima",
  "services": [
    {
      "name": "Prótese Parcial",
      "value": 1500.00
    },
    {
      "name": "Aparelho Ortodôntico",
      "value": 1200.00
    },
    {
      "name": "Contenção",
      "value": 500.00
    }
  ]
}

### 12. Create Order - Single Service
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {attendant_token}
Content-Type: application/json

{
  "lab": "Lab Express",
  "patient": "Carlos Mendes",
  "customer": "Dra. Fernanda Costa",
  "services": [
    {
      "name": "Limpeza Profunda",
      "value": 300.00
    }
  ]
}

### 13. Create Order - Invalid (Missing Services)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {attendant_token}
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": []
}

### 14. Create Order - Invalid (Service Value <= 0)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {attendant_token}
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço Inválido",
      "value": 0
    }
  ]
}

### 15. Create Order - No Authentication
POST {{apiUrl}}/orders HTTP/1.1
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço",
      "value": 100.00
    }
  ]
}

###############################################################################
### ORDERS - READ (All Authenticated Users Can View)
###############################################################################

### 16. List Orders - Attendant (Their Orders)
GET {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {attendant_token}

### 17. List Orders - Customer (Their Orders)
GET {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {customer_token}

### 18. List Orders - Paginated
GET {{apiUrl}}/orders?page=1&limit=10 HTTP/1.1
Authorization: Bearer {attendant_token}

### 19. List Orders - Filter by State CREATED
GET {{apiUrl}}/orders?state=CREATED HTTP/1.1
Authorization: Bearer {attendant_token}

### 20. List Orders - Filter by State ANALYSIS
GET {{apiUrl}}/orders?state=ANALYSIS HTTP/1.1
Authorization: Bearer {attendant_token}

### 21. List Orders - Filter by Status ACTIVE
GET {{apiUrl}}/orders?status=ACTIVE HTTP/1.1
Authorization: Bearer {attendant_token}

### 22. List Orders - Filter by Patient Name
GET {{apiUrl}}/orders?patientName=João HTTP/1.1
Authorization: Bearer {attendant_token}

### 23. List Orders - Sort by CreatedAt Descending
GET {{apiUrl}}/orders?sortBy=createdAt&sortOrder=desc HTTP/1.1
Authorization: Bearer {attendant_token}

### 24. Get Order by ID
GET {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {attendant_token}

### 25. Get User Statistics
GET {{apiUrl}}/orders/stats HTTP/1.1
Authorization: Bearer {attendant_token}

###############################################################################
### ORDERS - UPDATE (Only ATTENDANT/LAB_ADMIN Can Modify)
###############################################################################

### 26. Update Order - Change Customer (ATTENDANT)
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {attendant_token}
Content-Type: application/json

{
  "customer": "Dr. João Nova Silva"
}

### 27. Update Order - Update Services (ATTENDANT)
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {attendant_token}
Content-Type: application/json

{
  "services": [
    {
      "name": "Coroa de Zircônia",
      "value": 950.00,
      "status": "DONE"
    }
  ]
}

### 28. Update Order - Change Status (ATTENDANT)
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {attendant_token}
Content-Type: application/json

{
  "status": "DELETED"
}

### 29. Update Order - CUSTOMER Error (403)
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {customer_token}
Content-Type: application/json

{
  "customer": "Dr. Novo"
}

###############################################################################
### ORDERS - ADVANCE STATE (Only ATTENDANT/LAB_ADMIN)
###############################################################################

### 30. Advance Order State - ATTENDANT (CREATED -> ANALYSIS)
PATCH {{apiUrl}}/orders/{order_id}/advance HTTP/1.1
Authorization: Bearer {attendant_token}

### 31. Advance Order State - CUSTOMER Error (403)
PATCH {{apiUrl}}/orders/{order_id}/advance HTTP/1.1
Authorization: Bearer {customer_token}

###############################################################################
### ORDERS - DELETE (Only ATTENDANT/LAB_ADMIN)
###############################################################################

### 32. Delete Order - ATTENDANT
DELETE {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {attendant_token}

### 33. Delete Order - CUSTOMER Error (403)
DELETE {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {customer_token}

###############################################################################
### HEALTH CHECK
###############################################################################

### 34. Health Check
GET {{apiUrl}}/health HTTP/1.1

### 35. Root Endpoint
GET {{baseUrl}}/ HTTP/1.1

###############################################################################
### COMPLETE WORKFLOW EXAMPLE
###############################################################################

### Step 1: Register Attendant
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "workflow@lab.com",
  "password": "workflow123",
  "name": "Workflow Attendant",
  "role": "ATTENDANT"
}

### Step 2: Login as Attendant (Get Token)
POST {{apiUrl}}/users/login HTTP/1.1
Content-Type: application/json

{
  "email": "workflow@lab.com",
  "password": "workflow123"
}

### Step 3: Create Order (Use Token from Step 2)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_step2}
Content-Type: application/json

{
  "lab": "Lab Workflow",
  "patient": "Paciente Workflow",
  "customer": "Dr. Workflow",
  "services": [
    {
      "name": "Serviço Workflow",
      "value": 500.00
    }
  ]
}

### Step 4: List Orders (Use order_id from Step 3)
GET {{apiUrl}}/orders?state=CREATED HTTP/1.1
Authorization: Bearer {token_from_step2}

### Step 5: Advance Order State
PATCH {{apiUrl}}/orders/{order_id_from_step3}/advance HTTP/1.1
Authorization: Bearer {token_from_step2}

### Step 6: View Statistics
GET {{apiUrl}}/orders/stats HTTP/1.1
Authorization: Bearer {token_from_step2}

###############################################################################
### IMPORTANT NOTES FOR TESTING
###############################################################################

# ROLES AND PERMISSIONS:
# 1. CUSTOMER = Cliente/Paciente
#    - Pode fazer login
#    - Pode ver seus perfis
#    - NÃO pode criar pedidos ❌
#    - NÃO pode modificar pedidos ❌
#    - Pode visualizar pedidos em read-only ✅

# 2. ATTENDANT = Atendente/Funcionário (STAFF)
#    - Pode fazer login
#    - Pode criar pedidos ✅
#    - Pode modificar pedidos (PUT, DELETE) ✅
#    - Pode avançar estados ✅
#    - Pode ver estatísticas ✅

# 3. LAB_ADMIN = Administrador do Laboratório
#    - Acesso total igual a ATTENDANT
#    - Pode gerenciar todo o laboratório

# 4. SUPER_ADMIN = Super Administrador
#    - Acesso total do sistema

# FIELDS NO PEDIDO:
# - state: CREATED → ANALYSIS → COMPLETED
# - status: ACTIVE | DELETED

# COMO TESTAR:
# 1. Registre um usuário ATTENDANT
# 2. Faça login para obter o token
# 3. Substitua {attendant_token} pelo token real
# 4. Use o endpoint de criar pedido
# 5. Registre um CUSTOMER
# 6. Tente criar pedido com token CUSTOMER - deve falhar com 403!


###############################################################################
### ORDERS - CREATE
###############################################################################

### Create Order - Success
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "lab": "Lab Sorriso",
  "patient": "João Silva",
  "customer": "Dr. Maria Santos",
  "services": [
    {
      "name": "Coroa de Porcelana",
      "value": 800.00,
      "status": "PENDING"
    },
    {
      "name": "Implante Dentário",
      "value": 1700.00,
      "status": "PENDING"
    }
  ]
}

### Create Order - Multiple Services
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "lab": "Lab Perfecto",
  "patient": "Ana Costa",
  "customer": "Dr. Pedro Lima",
  "services": [
    {
      "name": "Prótese Parcial",
      "value": 1500.00
    },
    {
      "name": "Aparelho Ortodôntico",
      "value": 1200.00
    },
    {
      "name": "Contenção",
      "value": 500.00
    }
  ]
}

### Create Order - Single Service
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "lab": "Lab Express",
  "patient": "Carlos mendes",
  "customer": "Dra. Fernanda Costa",
  "services": [
    {
      "name": "Limpeza Profunda",
      "value": 300.00
    }
  ]
}

### Create Order - Invalid (Missing Services)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": []
}

### Create Order - Invalid (Service Value <= 0)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço Inválido",
      "value": 0
    }
  ]
}

### Create Order - Invalid (Missing Patient Name)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "lab": "Lab Test",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço",
      "value": 100.00
    }
  ]
}

### Create Order - No Authentication
POST {{apiUrl}}/orders HTTP/1.1
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço",
      "value": 100.00
    }
  ]
}

###############################################################################
### ORDERS - LIST & FILTER
###############################################################################

### List Orders - User's Orders (Paginated)
GET {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Page 2, Limit 5
GET {{apiUrl}}/orders?page=2&limit=5 HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Filter by State CREATED
GET {{apiUrl}}/orders?state=CREATED HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Filter by State ANALYSIS
GET {{apiUrl}}/orders?state=ANALYSIS HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Filter by Status ACTIVE
GET {{apiUrl}}/orders?status=ACTIVE HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Filter by Patient Name
GET {{apiUrl}}/orders?patientName=João HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Filter by Customer Name
GET {{apiUrl}}/orders?dentistName=Maria HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Sort by CreatedAt Ascending
GET {{apiUrl}}/orders?sortBy=createdAt&sortOrder=asc HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Sort by CreatedAt Descending
GET {{apiUrl}}/orders?sortBy=createdAt&sortOrder=desc HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - Complex Filter
GET {{apiUrl}}/orders?state=ANALYSIS&status=ACTIVE&page=1&limit=10&sortBy=createdAt&sortOrder=desc HTTP/1.1
Authorization: Bearer {token_from_login_response}

### List Orders - No Authentication
GET {{apiUrl}}/orders HTTP/1.1

###############################################################################
### ORDERS - GET BY ID
###############################################################################

### Get Order by ID
GET {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Get Order by ID - Invalid Format
GET {{apiUrl}}/orders/invalid-id HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Get Order by ID - Non-existent
GET {{apiUrl}}/orders/507f1f77bcf86cd799439999 HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Get Order by ID - No Authentication
GET {{apiUrl}}/orders/{order_id} HTTP/1.1

###############################################################################
### ORDERS - UPDATE
###############################################################################

### Update Order - Change Customer
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "customer": "Dr. João Nova Silva"
}

### Update Order - Update Services
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "services": [
    {
      "name": "Coroa de Zircônia",
      "value": 950.00,
      "status": "DONE"
    }
  ]
}

### Update Order - Change Status
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "status": "DELETED"
}

### Update Order - Invalid (Cannot change state)
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "state": "ANALYSIS"
}

### Update Order - No Services
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "services": []
}

### Update Order - No Authentication
PUT {{apiUrl}}/orders/{order_id} HTTP/1.1
Content-Type: application/json

{
  "customer": "Dr. Novo"
}

###############################################################################
### ORDERS - ADVANCE STATE
###############################################################################

### Advance Order State (CREATED -> ANALYSIS)
PATCH {{apiUrl}}/orders/{order_id}/advance HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Advance Order State - Already at Final State
PATCH {{apiUrl}}/orders/{order_id}/advance HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Advance Order State - No Authentication
PATCH {{apiUrl}}/orders/{order_id}/advance HTTP/1.1

###############################################################################
### ORDERS - DELETE
###############################################################################

### Delete Order
DELETE {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Delete Order - Already Deleted
DELETE {{apiUrl}}/orders/{order_id} HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Delete Order - No Authentication
DELETE {{apiUrl}}/orders/{order_id} HTTP/1.1

###############################################################################
### ORDERS - STATISTICS
###############################################################################

### Get User Order Statistics
GET {{apiUrl}}/orders/stats HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Get Stats - No Authentication
GET {{apiUrl}}/orders/stats HTTP/1.1

###############################################################################
### HEALTH CHECK
###############################################################################

### Health Check
GET {{apiUrl}}/health HTTP/1.1

### Root Endpoint
GET {{baseUrl}}/ HTTP/1.1

###############################################################################
### WORKFLOW EXAMPLES
###############################################################################

### Example Workflow - Step 1: Register
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "workflow@example.com",
  "password": "workflow123",
  "name": "Workflow User"
}

### Example Workflow - Step 2: Create Order
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {token_from_login_response}
Content-Type: application/json

{
  "lab": "Lab Workflow",
  "patient": "Paciente Workflow",
  "customer": "Dr. Workflow",
  "services": [
    {
      "name": "Serviço Workflow",
      "value": 500.00
    }
  ]
}

### Example Workflow - Step 3: List Orders
GET {{apiUrl}}/orders?state=CREATED HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Example Workflow - Step 4: Advance State
PATCH {{apiUrl}}/orders/{order_id}/advance HTTP/1.1
Authorization: Bearer {token_from_login_response}

### Example Workflow - Step 5: Get Statistics
GET {{apiUrl}}/orders/stats HTTP/1.1
Authorization: Bearer {token_from_login_response}

###############################################################################
### NOTES FOR TESTING
###############################################################################

# 1. First, register a user or login to get a token
# 2. Replace {token_from_login_response} with the actual JWT token from login
# 3. Replace {order_id} with an actual order ID from a create/list response
# 4. All order operations require authentication (Bearer token in Authorization header)
# 5. User registration is public (no authentication required)
# 6. Each user can only see/modify their own orders

