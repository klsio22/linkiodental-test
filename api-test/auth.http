### Lab Orders API - Test Collection with Authentication
### Base URL
@baseUrl = http://localhost:3000
@apiUrl = {{baseUrl}}/api

### AUTH TOKENS (Update these after login)
@attendant_token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5NWM0NTI3ODdhOTBmYjZjZDRhMjEzYyIsInJvbGUiOiJBVFRFTkRBTlQiLCJpYXQiOjE3Njc2NTUzODYsImV4cCI6MTc2ODI2MDE4Nn0.U4Tv_gPVrBQHqAyQhzfGgdhm82FS1jpQ5RakQuANSCU
@admin_token = your_admin_token_here

### ORDER ID (Update this after creating an order)
@order_id = 695c56846be3029e1e1ad8c1

###############################################################################
### USERS - REGISTRATION (Staff only - ATTENDANT and ADMINS)
###############################################################################

### 1. Register ATTENDANT (Staff - Can Create Orders)
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "attendant@lab.com",
  "password": "senha123",
  "name": "Maria Atendente",
  "role": "ATTENDANT"
}

### 2. Register LAB_ADMIN
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "admin@lab.com",
  "password": "admin123",
  "name": "Admin Lab",
  "role": "LAB_ADMIN"
}

### 3. Register SUPER_ADMIN
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "superadmin@lab.com",
  "password": "super123",
  "name": "Super Admin",
  "role": "SUPER_ADMIN"
}

###############################################################################
### USERS - LOGIN
###############################################################################

### 4. Login as ATTENDANT
POST {{apiUrl}}/users/login HTTP/1.1
Content-Type: application/json

{
  "email": "attendant@lab.com",
  "password": "senha123"
}

### 5. Login as LAB_ADMIN
POST {{apiUrl}}/users/login HTTP/1.1
Content-Type: application/json

{
  "email": "admin@lab.com",
  "password": "admin123"
}

###############################################################################
### USERS - PROFILE
###############################################################################

### 7. Get User Profile
GET {{apiUrl}}/users/profile HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 8. Update User Profile
PUT {{apiUrl}}/users/profile HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "name": "João Silva Updated"
}

###############################################################################
### ORDERS - CREATE (Only ATTENDANT/LAB_ADMIN/SUPER_ADMIN)
###############################################################################

### 9. Create Order - ATTENDANT Success
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Sorriso",
  "patient": "João Silva Updated",
  "customer": "Dr. Maria Santos",
  "services": [
    {
      "name": "Coroa de Porcelana",
      "value": 800.00,
      "status": "PENDING"
    },
    {
      "name": "Implante Dentário",
      "value": 1700.00,
      "status": "PENDING"
    }
  ]
}

### 10. Create Order - ATTENDANT - Single Service
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}   
Content-Type: application/json

{
  "lab": "Lab Sorriso",
  "patient": "Ana Silva",
  "customer": "Dr. Pedro Lima",
  "services": [
    {
      "name": "Limpeza",
      "value": 300.00
    }
  ]
}

### 11. Create Order - Multiple Services
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Perfecto",
  "patient": "Ana Costa",
  "customer": "Dr. Pedro Lima",
  "services": [
    {
      "name": "Prótese Parcial",
      "value": 1500.00
    },
    {
      "name": "Aparelho Ortodôntico",
      "value": 1200.00
    },
    {
      "name": "Contenção",
      "value": 500.00
    }
  ]
}

### 12. Create Order - Single Service
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Express",
  "patient": "Carlos Mendes",
  "customer": "Dra. Fernanda Costa",
  "services": [
    {
      "name": "Limpeza Profunda",
      "value": 300.00
    }
  ]
}

### 13. Create Order - Invalid (Missing Services)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": []
}

### 14. Create Order - Invalid (Service Value <= 0)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço Inválido",
      "value": 0
    }
  ]
}

### 15. Create Order - No Authentication
POST {{apiUrl}}/orders HTTP/1.1
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço",
      "value": 100.00
    }
  ]
}

###############################################################################
### ORDERS - READ (All Authenticated Staff Can View)
###############################################################################

### 16. List Orders - Attendant (Their Orders)
GET {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 17. List Orders - Admin (All Orders)
GET {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{admin_token}}

### 18. List Orders - Paginated
GET {{apiUrl}}/orders?page=1&limit=10 HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 19. List Orders - Filter by State CREATED
GET {{apiUrl}}/orders?state=CREATED HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 20. List Orders - Filter by State ANALYSIS
GET {{apiUrl}}/orders?state=ANALYSIS HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 21. List Orders - Filter by Status ACTIVE
GET {{apiUrl}}/orders?status=ACTIVE HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 22. List Orders - Filter by Patient Name
GET {{apiUrl}}/orders?patientName=João HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 23. List Orders - Sort by CreatedAt Descending
GET {{apiUrl}}/orders?sortBy=createdAt&sortOrder=desc HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 24. Get Order by ID
GET {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 25. Get User Statistics
GET {{apiUrl}}/orders/stats HTTP/1.1
Authorization: Bearer {{attendant_token}}

###############################################################################
### ORDERS - UPDATE (Only ATTENDANT/LAB_ADMIN Can Modify)
###############################################################################

### 26. Update Order - Change Customer (ATTENDANT)
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "customer": "Dr. João Nova Silva"
}

### 27. Update Order - Update Services (ATTENDANT)
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "services": [
    {
      "name": "Coroa de Zircônia",
      "value": 950.00,
      "status": "DONE"
    }
  ]
}

### 28. Update Order - Change Status (ATTENDANT)
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "status": "DELETED"
}

### 29. Update Order - No Authentication (Error)
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Content-Type: application/json

{
  "customer": "Dr. Novo"
}

###############################################################################
### ORDERS - ADVANCE STATE (Only ATTENDANT/LAB_ADMIN)
###############################################################################

### 30. Advance Order State - ATTENDANT (CREATED -> ANALYSIS)
PATCH {{apiUrl}}/orders/{{{order_id}}}/advance HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 31. Advance Order State - No Authentication (Error)
PATCH {{apiUrl}}/orders/{{{order_id}}}/advance HTTP/1.1

###############################################################################
### ORDERS - DELETE (Only ATTENDANT/LAB_ADMIN)
###############################################################################

### 32. Delete Order - ATTENDANT
DELETE {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}

### 33. Delete Order - No Authentication (Error)
DELETE {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1

###############################################################################
### HEALTH CHECK
###############################################################################

### 34. Health Check
GET {{apiUrl}}/health HTTP/1.1

### 35. Root Endpoint
GET {{baseUrl}}/ HTTP/1.1

###############################################################################
### COMPLETE WORKFLOW EXAMPLE
###############################################################################

### Step 1: Register Attendant
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "workflow@lab.com",
  "password": "workflow123",
  "name": "Workflow Attendant",
  "role": "ATTENDANT"
}

### Step 2: Login as Attendant (Get Token)
POST {{apiUrl}}/users/login HTTP/1.1
Content-Type: application/json

{
  "email": "workflow@lab.com",
  "password": "workflow123"
}

### Step 3: Create Order (Use Token from Step 2)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Workflow",
  "patient": "Paciente Workflow",
  "customer": "Dr. Workflow",
  "services": [
    {
      "name": "Serviço Workflow",
      "value": 500.00
    }
  ]
}

### Step 4: List Orders (Use order_id from Step 3)
GET {{apiUrl}}/orders?state=CREATED HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Step 5: Advance Order State
PATCH {{apiUrl}}/orders/{{{order_id}}}/advance HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Step 6: View Statistics
GET {{apiUrl}}/orders/stats HTTP/1.1
Authorization: Bearer {{attendant_token}}

###############################################################################
### IMPORTANT NOTES FOR TESTING
###############################################################################

# ROLES AND PERMISSIONS (Sistema apenas para Staff):
# 1. ATTENDANT = Atendente/Funcionário (STAFF)
#    - Pode fazer login ✅
#    - Pode criar pedidos ✅
#    - Pode modificar pedidos (PUT, DELETE) ✅
#    - Pode avançar estados ✅
#    - Pode ver estatísticas ✅
#    - Vê apenas seus próprios pedidos

# 2. LAB_ADMIN = Administrador do Laboratório
#    - Acesso total igual a ATTENDANT ✅
#    - Pode gerenciar todo o laboratório

# 3. SUPER_ADMIN = Super Administrador
#    - Acesso total do sistema ✅

# FIELDS NO PEDIDO:
# - state: CREATED → ANALYSIS → COMPLETED
# - status: ACTIVE | DELETED

# VALIDAÇÕES:
# - ❌ Não pode criar pedido sem serviços
# - ❌ Não pode avançar estado se já estiver COMPLETED
# - ✅ Cada usuário vê apenas seus pedidos
# - ✅ Orders podem ser duplicadas (permitido)

# COMO TESTAR:
# 1. Registre um usuário ATTENDANT ou LAB_ADMIN
# 2. Faça login para obter o token
# 3. Atualize @attendant_token ou @admin_token com o token real
# 4. Use os endpoints normalmente


###############################################################################
### ORDERS - CREATE
###############################################################################

### Create Order - Success
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Sorriso",
  "patient": "João Silva",
  "customer": "Dr. Maria Santos",
  "services": [
    {
      "name": "Coroa de Porcelana",
      "value": 800.00,
      "status": "PENDING"
    },
    {
      "name": "Implante Dentário",
      "value": 1700.00,
      "status": "PENDING"
    }
  ]
}

### Create Order - Multiple Services
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Perfecto",
  "patient": "Ana Costa",
  "customer": "Dr. Pedro Lima",
  "services": [
    {
      "name": "Prótese Parcial",
      "value": 1500.00
    },
    {
      "name": "Aparelho Ortodôntico",
      "value": 1200.00
    },
    {
      "name": "Contenção",
      "value": 500.00
    }
  ]
}

### Create Order - Single Service
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Express",
  "patient": "Carlos mendes",
  "customer": "Dra. Fernanda Costa",
  "services": [
    {
      "name": "Limpeza Profunda",
      "value": 300.00
    }
  ]
}

### Create Order - Invalid (Missing Services)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": []
}

### Create Order - Invalid (Service Value <= 0)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço Inválido",
      "value": 0
    }
  ]
}

### Create Order - Invalid (Missing Patient Name)
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Test",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço",
      "value": 100.00
    }
  ]
}

### Create Order - No Authentication
POST {{apiUrl}}/orders HTTP/1.1
Content-Type: application/json

{
  "lab": "Lab Test",
  "patient": "Teste",
  "customer": "Dr. Teste",
  "services": [
    {
      "name": "Serviço",
      "value": 100.00
    }
  ]
}

###############################################################################
### ORDERS - LIST & FILTER
###############################################################################

### List Orders - User's Orders (Paginated)
GET {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Page 2, Limit 5
GET {{apiUrl}}/orders?page=2&limit=5 HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Filter by State CREATED
GET {{apiUrl}}/orders?state=CREATED HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Filter by State ANALYSIS
GET {{apiUrl}}/orders?state=ANALYSIS HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Filter by Status ACTIVE
GET {{apiUrl}}/orders?status=ACTIVE HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Filter by Patient Name
GET {{apiUrl}}/orders?patientName=João HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Filter by Customer Name
GET {{apiUrl}}/orders?dentistName=Maria HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Sort by CreatedAt Ascending
GET {{apiUrl}}/orders?sortBy=createdAt&sortOrder=asc HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Sort by CreatedAt Descending
GET {{apiUrl}}/orders?sortBy=createdAt&sortOrder=desc HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - Complex Filter
GET {{apiUrl}}/orders?state=ANALYSIS&status=ACTIVE&page=1&limit=10&sortBy=createdAt&sortOrder=desc HTTP/1.1
Authorization: Bearer {{attendant_token}}

### List Orders - No Authentication
GET {{apiUrl}}/orders HTTP/1.1

###############################################################################
### ORDERS - GET BY ID
###############################################################################

### Get Order by ID
GET {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Get Order by ID - Invalid Format
GET {{apiUrl}}/orders/invalid-id HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Get Order by ID - Non-existent
GET {{apiUrl}}/orders/507f1f77bcf86cd799439999 HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Get Order by ID - No Authentication
GET {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1

###############################################################################
### ORDERS - UPDATE
###############################################################################

### Update Order - Change Customer
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "customer": "Dr. João Nova Silva"
}

### Update Order - Update Services
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "services": [
    {
      "name": "Coroa de Zircônia",
      "value": 950.00,
      "status": "DONE"
    }
  ]
}

### Update Order - Change Status
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "status": "DELETED"
}

### Update Order - Invalid (Cannot change state)
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "state": "ANALYSIS"
}

### Update Order - No Services
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "services": []
}

### Update Order - No Authentication
PUT {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Content-Type: application/json

{
  "customer": "Dr. Novo"
}

###############################################################################
### ORDERS - ADVANCE STATE
###############################################################################

### Advance Order State (CREATED -> ANALYSIS)
PATCH {{apiUrl}}/orders/{{{order_id}}}/advance HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Advance Order State - Already at Final State
PATCH {{apiUrl}}/orders/{{{order_id}}}/advance HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Advance Order State - No Authentication
PATCH {{apiUrl}}/orders/{{{order_id}}}/advance HTTP/1.1

###############################################################################
### ORDERS - DELETE
###############################################################################

### Delete Order
DELETE {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Delete Order - Already Deleted
DELETE {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Delete Order - No Authentication
DELETE {{apiUrl}}/orders/{{{order_id}}} HTTP/1.1

###############################################################################
### ORDERS - STATISTICS
###############################################################################

### Get User Order Statistics
GET {{apiUrl}}/orders/stats HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Get Stats - No Authentication
GET {{apiUrl}}/orders/stats HTTP/1.1

###############################################################################
### HEALTH CHECK
###############################################################################

### Health Check
GET {{apiUrl}}/health HTTP/1.1

### Root Endpoint
GET {{baseUrl}}/ HTTP/1.1

###############################################################################
### WORKFLOW EXAMPLES
###############################################################################

### Example Workflow - Step 1: Register
POST {{apiUrl}}/users/register HTTP/1.1
Content-Type: application/json

{
  "email": "workflow@example.com",
  "password": "workflow123",
  "name": "Workflow User"
}

### Example Workflow - Step 2: Create Order
POST {{apiUrl}}/orders HTTP/1.1
Authorization: Bearer {{attendant_token}}
Content-Type: application/json

{
  "lab": "Lab Workflow",
  "patient": "Paciente Workflow",
  "customer": "Dr. Workflow",
  "services": [
    {
      "name": "Serviço Workflow",
      "value": 500.00
    }
  ]
}

### Example Workflow - Step 3: List Orders
GET {{apiUrl}}/orders?state=CREATED HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Example Workflow - Step 4: Advance State
PATCH {{apiUrl}}/orders/{{{order_id}}}/advance HTTP/1.1
Authorization: Bearer {{attendant_token}}

### Example Workflow - Step 5: Get Statistics
GET {{apiUrl}}/orders/stats HTTP/1.1
Authorization: Bearer {{attendant_token}}

###############################################################################
### NOTES FOR TESTING
###############################################################################

# 1. First, register a user or login to get a token
# 2. Replace {token_from_login_response} with the actual JWT token from login
# 3. Replace {{order_id}} with an actual order ID from a create/list response
# 4. All order operations require authentication (Bearer token in Authorization header)
# 5. User registration is public (no authentication required)
# 6. Each user can only see/modify their own orders

